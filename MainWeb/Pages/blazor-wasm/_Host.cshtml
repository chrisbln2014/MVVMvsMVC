@page "/blazor-wasm/{*path:nonfile}"
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blazor WebAssembly</title>
    <base href="/blazor-wasm/" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link href="css/app.css" rel="stylesheet" />
    
    <!-- ç¢ºä¿é€™å€‹æ¨£å¼è¡¨è·¯å¾‘æ­£ç¢ºæˆ–ç§»é™¤å®ƒï¼Œå¦‚æœä¸å­˜åœ¨ -->
    @* <link href="Blazor-WebAssembly.styles.css" rel="stylesheet" /> *@
    
    <!-- ç§»é™¤è‡ªå‹•å•Ÿå‹•å±¬æ€§ï¼Œä»¥ä¾¿æˆ‘å€‘å¯ä»¥è¨­å®šè‡ªå®šç¾©è¼‰å…¥è¡Œç‚º -->
    <script src="_framework/blazor.webassembly.js" autostart="false"></script>
    
    <!-- æ·»åŠ è©³ç´°çš„éŒ¯èª¤æ•ç²å’Œè¨˜éŒ„ -->
    <script>
        // å®‰å…¨åœ°æ›´æ–°å…ƒç´ æ–‡æœ¬çš„è¼”åŠ©å‡½æ•¸
        function safeSetElementText(selector, text) {
            var element = document.querySelector(selector);
            if (element) {
                element.innerHTML = text;
            } else {
                // æ‡‰ç”¨å·²å•Ÿå‹•å¾Œå°±ä¸éœ€è¦å†é¡¯ç¤ºæ­¤è­¦å‘Š
                if (!window.appStarted) {
                    console.warn(`å…ƒç´ ä¸å­˜åœ¨: ${selector}`);
                }
            }
        }
        
        // å…¨å±€éŒ¯èª¤è™•ç†
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('å…¨å±€éŒ¯èª¤æ•ç²:', {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
            safeSetElementText('.loading-progress-text', 
                `ç™¼ç”ŸéŒ¯èª¤: ${message}<br>ä½ç½®: ${source}:${lineno}:${colno}`);
            return false;
        };
        
        // æœªè™•ç†çš„ Promise éŒ¯èª¤
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„ Promise æ‹’çµ•:', event.reason);
            safeSetElementText('.loading-progress-text', 
                `æœªè™•ç†çš„ Promise éŒ¯èª¤: ${event.reason}`);
        });
    </script>
</head>
<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui" style="display:none;">
        ç™¼ç”Ÿæœªè™•ç†çš„éŒ¯èª¤ã€‚
        <a href="" class="reload">é‡æ–°è¼‰å…¥</a>
        <a class="dismiss">ğŸ—™</a>
    </div>
    
    <script>
        // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•ç‹€æ…‹è¿½è¹¤
        window.appStarted = false;
        
        // è©³ç´°è¨˜éŒ„å•Ÿå‹•éç¨‹
        console.log(`[${new Date().toISOString()}] åˆå§‹åŒ– Blazor WebAssembly...`);
        
        // æ·»åŠ è©³ç´°éšæ®µè¨˜éŒ„
        var startTime = performance.now();
        var stages = {};
        
        function logStage(stageName) {
            var now = performance.now();
            var elapsed = now - startTime;
            stages[stageName] = elapsed;
            console.log(`[${new Date().toISOString()}] éšæ®µ: ${stageName}, è€—æ™‚: ${elapsed.toFixed(2)}ms`);
            
            // åªåœ¨æ‡‰ç”¨å°šæœªå•Ÿå‹•æ™‚å˜—è©¦æ›´æ–°è¼‰å…¥æ–‡æœ¬
            if (!window.appStarted) {
                safeSetElementText('.loading-progress-text', `è¼‰å…¥ä¸­: ${stageName}...`);
            }
        }
        
        // ç¢ºä¿ DOM å®Œå…¨è¼‰å…¥å¾Œå†æ“ä½œå…ƒç´ 
        document.addEventListener('DOMContentLoaded', function() {
            logStage('é é¢åˆå§‹åŒ–');
            
            // æª¢æŸ¥æ‰€éœ€çš„ DOM å…ƒç´ æ˜¯å¦å­˜åœ¨
            if (!document.querySelector('.loading-progress-text')) {
                console.error('ç¼ºå°‘å¿…è¦çš„ DOM å…ƒç´ : .loading-progress-text');
                // å˜—è©¦å‰µå»ºå…ƒç´ 
                var textEl = document.createElement('div');
                textEl.className = 'loading-progress-text';
                document.querySelector('#app')?.appendChild(textEl);
            }
            
            // ä¿®æ”¹è¼‰å…¥è³‡æºçš„æ–¹æ³•ä»¥è¨˜éŒ„æ›´å¤šè©³æƒ…
            try {
                logStage('é–‹å§‹è¼‰å…¥ Blazor');
                
                Blazor.start({
                    loadBootResource: function (type, name, defaultUri, integrity) {
                        logStage(`è¼‰å…¥è³‡æº: ${type}/${name}`);
                        
                        // è¨˜éŒ„è³‡æºè©³ç´°ä¿¡æ¯
                        console.log({
                            resourceType: type,
                            resourceName: name,
                            uri: defaultUri,
                            hasIntegrity: !!integrity
                        });
                        
                        // é€šéç›´æ¥è¿”å›ä¸€å€‹ fetch è«‹æ±‚ä¾†ç•¥éå…§å»ºçš„å®Œæ•´æ€§é©—è­‰
                        if (type !== 'dotnetjs') {
                            console.log(`ä½¿ç”¨è‡ªå®šç¾©è«‹æ±‚è¼‰å…¥: ${name}`);
                            return fetch(defaultUri, {
                                cache: 'no-cache',
                                integrity: '',  // æ¸…ç©ºå®Œæ•´æ€§å±¬æ€§
                                credentials: 'same-origin',
                                headers: {
                                    'Pragma': 'no-cache',
                                    'Cache-Control': 'no-cache'
                                }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    console.error(`è³‡æº ${name} è¼‰å…¥å¤±æ•—:`, response.status, response.statusText);
                                    throw new Error(`è³‡æºè¼‰å…¥å¤±æ•—: ${response.status} ${response.statusText}`);
                                }
                                logStage(`è³‡æº ${name} è¼‰å…¥æˆåŠŸ`);
                                return response;
                            })
                            .catch(error => {
                                console.error(`è³‡æº ${name} è¼‰å…¥å‡ºéŒ¯:`, error);
                                throw error;
                            });
                        }
                        
                        // å°æ–¼ dotnetjs é¡å‹çš„è³‡æºï¼Œä½¿ç”¨é è¨­çš„ URI
                        return defaultUri;
                    }
                }).then(function () {
                    // æ¨™è¨˜æ‡‰ç”¨å·²å•Ÿå‹•ï¼Œä¸å†éœ€è¦è¼‰å…¥æŒ‡ç¤ºå™¨
                    window.appStarted = true;
                    
                    logStage('Blazor WebAssembly åˆå§‹åŒ–å®Œæˆ');
                    console.log(`[${new Date().toISOString()}] Blazor WebAssembly å•Ÿå‹•æˆåŠŸ!`);
                    console.table(stages);
                    
                    // æ‡‰ç”¨ç¨‹å¼å•Ÿå‹•å¾Œçš„è‡ªæˆ‘è¨ºæ–·
                    console.log('æ‡‰ç”¨ç¨‹å¼ç‹€æ…‹æª¢æŸ¥:');
                    console.log('- Blazor å¯¦ä¾‹å­˜åœ¨:', !!window.Blazor);
                    
                    // å®‰å…¨åœ°æª¢æŸ¥ DOM å…ƒç´ 
                    var appElement = document.querySelector('#app');
                    console.log('- æ‡‰ç”¨ç¨‹å¼å…ƒç´ å­˜åœ¨:', !!appElement);
                    if (appElement) {
                        console.log('- æ‡‰ç”¨ç¨‹å¼å…ƒç´ å…§å®¹:', appElement.innerHTML);
                    }
                }).catch(function (error) {
                    logStage('Blazor WebAssembly åˆå§‹åŒ–å¤±æ•—');
                    console.error(`[${new Date().toISOString()}] Blazor WebAssembly å•Ÿå‹•å¤±æ•—:`, error);
                    console.error('è©³ç´°éŒ¯èª¤:', error.toString());
                    console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                    console.table(stages);
                    
                    // åœ¨é é¢ä¸Šå®‰å…¨åœ°é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    safeSetElementText('.loading-progress-text', 
                        `è¼‰å…¥å¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}<br>
                        è«‹æª¢æŸ¥æ§åˆ¶å°ä»¥ç²å–æ›´å¤šä¿¡æ¯ã€‚<br>
                        <small>${error.stack ? error.stack.split('\n')[0] : ''}</small>`);
                });
            } catch (ex) {
                console.error('å•Ÿå‹• Blazor æ™‚ç™¼ç”Ÿåš´é‡éŒ¯èª¤:', ex);
                safeSetElementText('.loading-progress-text', `åš´é‡éŒ¯èª¤ï¼š${ex.message}`);
            }
        });
    </script>
</body>
</html>