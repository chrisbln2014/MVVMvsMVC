@page "/blazor-wasm/{*path:nonfile}"
@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="zh-tw">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blazor WebAssembly</title>
    <base href="/blazor-wasm/" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" />
    <link href="css/app.css" rel="stylesheet" />
    
    <script src="_framework/blazor.webassembly.js" autostart="false"></script>
    
    <script>
        // å®‰å…¨åœ°æ›´æ–°å…ƒç´ æ–‡æœ¬çš„è¼”åŠ©å‡½æ•¸
        function safeSetElementText(selector, text) {
            var element = document.querySelector(selector);
            if (element) {
                element.innerHTML = text;
            }
        }
        
        // è¨˜éŒ„å•Ÿå‹•éšæ®µçš„æ™‚é–“
        var startTime = performance.now();
        var stages = {};
        
        function logStage(stageName) {
            var now = performance.now();
            var elapsed = now - startTime;
            stages[stageName] = elapsed;
            console.log(`[${new Date().toISOString()}] ${stageName}, è€—æ™‚: ${elapsed.toFixed(2)}ms`);
            
            // æ›´æ–°è¼‰å…¥æ–‡å­—
            if (!window.appStarted) {
                safeSetElementText('.loading-progress-text', `${stageName}...`);
            }
        }

        // ç­‰å¾… DOM è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            logStage('é é¢åˆå§‹åŒ–');
            
            try {
                Blazor.start({
                    loadBootResource: function (type, name, defaultUri, integrity) {
                        logStage(`è¼‰å…¥è³‡æº: ${type}/${name}`);
                        
                        if (type !== 'dotnetjs') {
                            return fetch(defaultUri, {
                                cache: 'no-cache',
                                integrity: '',
                                headers: { 'Cache-Control': 'no-cache' }
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`è³‡æºè¼‰å…¥å¤±æ•—: ${response.status} ${response.statusText}`);
                                }
                                logStage(`è³‡æº ${name} è¼‰å…¥æˆåŠŸ`);
                                return response;
                            });
                        }
                        return defaultUri;
                    }
                }).then(function () {
                    window.appStarted = true;
                    logStage('æ‡‰ç”¨ç¨‹å¼è¼‰å…¥å®Œæˆ');
                    console.table(stages);
                }).catch(function (error) {
                    console.error('Blazor è¼‰å…¥å¤±æ•—:', error);
                    safeSetElementText('.loading-progress-text', 
                        `è¼‰å…¥å¤±æ•—ï¼š${error.message || 'æœªçŸ¥éŒ¯èª¤'}<br>è«‹é‡æ–°æ•´ç†é é¢æˆ–è¯çµ¡ç³»çµ±ç®¡ç†å“¡`);
                });
            } catch (ex) {
                console.error('åš´é‡éŒ¯èª¤:', ex);
                safeSetElementText('.loading-progress-text', `åš´é‡éŒ¯èª¤ï¼š${ex.message}`);
            }
        });

        // å…¨å±€éŒ¯èª¤è™•ç†
        window.onerror = function(message, source, lineno, colno, error) {
            console.error('å…¨å±€éŒ¯èª¤:', {
                message: message,
                source: source,
                lineno: lineno,
                colno: colno,
                error: error
            });
            safeSetElementText('.loading-progress-text', 
                `ç™¼ç”ŸéŒ¯èª¤: ${message}<br>è«‹é‡æ–°æ•´ç†é é¢`);
            return false;
        };
        
        // æœªè™•ç†çš„ Promise éŒ¯èª¤
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªè™•ç†çš„ Promise éŒ¯èª¤:', event.reason);
            safeSetElementText('.loading-progress-text', 
                `è¼‰å…¥å¤±æ•—: ${event.reason.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        });
    </script>
</head>
<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui" style="display:none;">
        ç™¼ç”Ÿæœªè™•ç†çš„éŒ¯èª¤ã€‚
        <a href="" class="reload">é‡æ–°æ•´ç†</a>
        <span class="dismiss">ğŸ—™</span>
    </div>
</body>
</html>